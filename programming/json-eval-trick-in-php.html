<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<title>JSON Eval Trick in PHP</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="description" content="JSON Eval Trick in PHP" />
<link rel="stylesheet" type="text/css" href="../css/style.css" />
<link rel="alternate" type="application/rss+xml" title="I'm Jex" href="../rss.xml"/>
<link rel="shortcut icon" href="../favicon.png" type="image/png" />
</head>
<body>
  <nav class="category-path">
   <a href="../index.html" rel="home">Home</a> »
    
    <a href="../programming/index.html" rel="category">Programming</a> »
    
    <em>JSON Eval Trick in PHP</em>
</nav>

  <h1 class="article-title">
    <a href="./json-eval-trick-in-php.html" rel="self" class="normal">JSON Eval Trick in PHP</a>
  </h1>
  <div class="title-info">
    <small><a href="https://jex.im/" rel="author" class="normal">Jex</a> — <time>2009-11-11</time></small>
  </div>


  
  <article  id="main">
    <p>
PHP从5.2版本开始提供<a href="http://www.php.net/manual/en/function.json-encode.php" target="_blank">json_encode()</a>和<a href="http://www.php.net/manual/en/function.json-decode.php" target="_blank">json_decode()</a>函数，分别用于JSON的序例化和反序列化。不幸的是，现在仍然有许多主机运行着PHP5.2之前的版本，所以我就不得不自己动手、丰衣足食了。</p>

<h3>JSON Encode</h3>
<p>JSON的编码并没有什么难度，要点就两个：</p>
<ul>
  <li>对Object、Array中的元素进行递归遍历，注意将关联数组转换成JSON中的Object Literal。</li>
  <li>对字符串中引号、换行符等特殊字符进行转义，将非ASCII字符转换成<a href="https://developer.mozilla.org/en-US/docs/JavaScript/Guide/Values,_variables,_and_literals#Unicode_escape_sequences" target="_blank">Unicode转义序列</a>。</li>
</ul>

<p>下面是JSON编码方法的实现：</p>
<div class="highlight"><pre><span></span><span class="sd">/**</span>
<span class="sd"> * JSON Encode</span>
<span class="sd"> * @warn Any input string must be UTF-8 encoding</span>
<span class="sd"> * @param {Any} $data Any type object to serialize.</span>
<span class="sd"> * @return {String} serialized json string.</span>
<span class="sd"> */</span>
<span class="k">function</span> <span class="nf">json_stringify</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">is_null</span><span class="p">(</span><span class="nv">$data</span><span class="p">))</span> <span class="k">return</span> <span class="s1">&#39;null&#39;</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">is_scalar</span><span class="p">(</span><span class="nv">$data</span><span class="p">))</span> <span class="k">return</span> <span class="nx">json_stringify_scalar</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$data</span><span class="p">))</span> <span class="k">return</span> <span class="s1">&#39;[]&#39;</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">is_object</span><span class="p">(</span><span class="nv">$data</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$data</span><span class="o">=</span><span class="nb">get_object_vars</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$data</span><span class="p">))</span> <span class="k">return</span> <span class="s1">&#39;{}&#39;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nv">$keys</span><span class="o">=</span><span class="nb">array_keys</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nv">$keys</span><span class="o">===</span><span class="nb">array_keys</span><span class="p">(</span><span class="nv">$keys</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$data</span><span class="o">=</span><span class="nb">array_map</span><span class="p">(</span><span class="no">__FUNCTION__</span><span class="p">,</span><span class="nv">$data</span><span class="p">);</span>
    <span class="k">return</span> <span class="s1">&#39;[&#39;</span><span class="o">.</span><span class="nb">join</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span><span class="nv">$data</span><span class="p">)</span><span class="o">.</span><span class="s1">&#39;]&#39;</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span><span class="c1">//不是有序数字下标的数组即视为关联数组</span>
    <span class="nv">$a</span><span class="o">=</span><span class="k">array</span><span class="p">();</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="nv">$data</span> <span class="k">as</span> <span class="nv">$k</span><span class="o">=&gt;</span><span class="nv">$v</span><span class="p">)</span> <span class="p">{</span>
      <span class="nv">$a</span><span class="p">[]</span><span class="o">=</span><span class="nx">json_stringify_scalar</span><span class="p">(</span><span class="nb">strval</span><span class="p">(</span><span class="nv">$k</span><span class="p">))</span><span class="o">.</span><span class="s1">&#39;:&#39;</span><span class="o">.</span><span class="nx">json_stringify</span><span class="p">(</span><span class="nv">$v</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="s1">&#39;{&#39;</span><span class="o">.</span><span class="nb">join</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span><span class="nv">$a</span><span class="p">)</span><span class="o">.</span><span class="s1">&#39;}&#39;</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">json_stringify_scalar</span><span class="p">(</span><span class="nv">$v</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">is_bool</span><span class="p">(</span><span class="nv">$v</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$v</span> <span class="o">=</span> <span class="nv">$v</span><span class="o">?</span><span class="s1">&#39;true&#39;</span><span class="o">:</span><span class="s1">&#39;false&#39;</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nb">is_string</span><span class="p">(</span><span class="nv">$v</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$v</span><span class="o">=</span><span class="nb">addcslashes</span><span class="p">(</span><span class="nv">$v</span><span class="p">,</span><span class="s2">&quot;</span><span class="se">\t\n\r\&quot;</span><span class="s2">\/</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">);</span><span class="c1">//转义特殊字符</span>
    <span class="c1">//将所有非ASCII字符转换成Unicode Escape格式</span>
    <span class="nv">$v</span><span class="o">=</span><span class="s1">&#39;&quot;&#39;</span><span class="o">.</span><span class="nb">preg_replace_callback</span><span class="p">(</span>
             <span class="s1">&#39;|[^\x00-\x7F]+|&#39;</span><span class="p">,</span><span class="s1">&#39;_unicode_escape&#39;</span><span class="p">,</span><span class="nv">$v</span><span class="p">)</span><span class="o">.</span><span class="s1">&#39;&quot;&#39;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="p">(</span><span class="nx">string</span><span class="p">)</span><span class="nv">$v</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">_unicode_escape</span><span class="p">(</span><span class="nv">$s</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">//Warning:源字符串必须为UTF-8编码</span>
  <span class="nv">$s</span><span class="o">=</span><span class="nb">str_split</span><span class="p">(</span><span class="nb">iconv</span><span class="p">(</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">,</span><span class="s1">&#39;UCS-2BE&#39;</span><span class="p">,</span><span class="nv">$s</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="mi">2</span><span class="p">);</span>
  <span class="k">foreach</span> <span class="p">(</span><span class="nv">$s</span> <span class="k">as</span> <span class="nv">$i</span><span class="o">=&gt;</span><span class="nv">$c</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$s</span><span class="p">[</span><span class="nv">$i</span><span class="p">]</span><span class="o">=</span><span class="nb">sprintf</span><span class="p">(</span><span class="s1">&#39;\u%02x%02x&#39;</span><span class="p">,</span><span class="nb">ord</span><span class="p">(</span><span class="nv">$c</span><span class="p">{</span><span class="mi">0</span><span class="p">}),</span><span class="nb">ord</span><span class="p">(</span><span class="nv">$c</span><span class="p">{</span><span class="mi">1</span><span class="p">}));</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nb">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="nv">$s</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>

<h3>JSON Decode</h3>
<p>
而将JSON转换成PHP中的对象就没有这么简单了，手写Parser是个累人的体力活。反观在JavaScript中实现JSON Parse就简单多了，因为JSON本身即是JavaScript语言的子集，直接使用eval方法，就能将JSON字符串转换成JS中的对象。
</p>

<p>
其实，看到JavaScript中的 eval 方法，实在不能不联想到PHP也有一个<a href="http://php.net/manual/en/function.eval.php" target="_blank">eval</a>，它们的功能是类似的，都是将字符串当作代码运行。不同的是，JS中的eval执行JS代码，PHP的eval执行PHP代码。<strong>Trick就在这里</strong>：要让PHP能直接用eval方法解析JSON，只要将JSON代码转换成PHP格式的代码就行了！如对于下面的JSON：
</p>

<div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;CJ&quot;</span><span class="p">,</span>
  <span class="nt">&quot;age&quot;</span><span class="p">:</span><span class="mi">18</span><span class="p">,</span>
  <span class="nt">&quot;tags&quot;</span><span class="p">:[</span><span class="s2">&quot;PHP&quot;</span><span class="p">,</span><span class="s2">&quot;JavaScript&quot;</span><span class="p">,</span><span class="s2">&quot;Python&quot;</span><span class="p">,</span><span class="s2">&quot;Haskell&quot;</span><span class="p">],</span>
  <span class="nt">&quot;life&quot;</span><span class="p">:{</span>
    <span class="nt">&quot;summary&quot;</span><span class="p">:</span><span class="s2">&quot;Too complex!&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>只要将其转换成这样的PHP代码就能直接 eval 了：</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="nx">object</span><span class="p">)</span><span class="k">array</span><span class="p">(</span>
  <span class="s2">&quot;name&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;CJ&quot;</span><span class="p">,</span>
  <span class="s2">&quot;age&quot;</span><span class="o">=&gt;</span><span class="mi">18</span><span class="p">,</span>
  <span class="s2">&quot;tags&quot;</span><span class="o">=&gt;</span><span class="k">array</span><span class="p">(</span><span class="s2">&quot;PHP&quot;</span><span class="p">,</span><span class="s2">&quot;JavaScript&quot;</span><span class="p">,</span><span class="s2">&quot;Python&quot;</span><span class="p">,</span><span class="s2">&quot;Haskell&quot;</span><span class="p">),</span>
  <span class="s2">&quot;life&quot;</span><span class="o">=&gt;</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span><span class="k">array</span><span class="p">(</span>
    <span class="s2">&quot;summary&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;Too complex!&quot;</span>
  <span class="p">)</span>
<span class="p">)</span>
</pre></div>

<p>而将JSON转换成PHP代码则只需很少的步骤与注意点：</p>
<ol>
  <li>先提取出字符串，然后就可安心地做一些类似将<code>[]</code>替换成<code>array()</code>的操作了。怎样用正则表达式匹配出一个完整的字符串字面量呢？很明显双引号匹配字符串开始，JSON中字符串必定是用双引号引起的。而匹配字符串结束则需要一个<strong>前面有偶数个后向转义斜线的双引号</strong>，因为字符串中也可以包含双引号，但它前面一定有奇数个后向转义斜线，如<code>"Quotes here:\"..."</code>。使用正则表达式的<a href="http://www.php.net/manual/zh/regexp.reference.assertions.php" target="_blank">否定式后瞻断言</a>可以一步做到这样的匹配。</li>
  <li>再将<code>[1,2]</code>、<code>{"k":"v"}</code>转换成<code>array(1,2)</code>、<code>(object)array("k"=>"v")</code>这样的格式。</li>
  <li>Number、Boolean、Null值保持原样，直接交给PHP的eval方法。</li>
  <li>因为PHP不支持Unicode转义序列，所以需要将String中的Unicode转义序列转换成对应的字符。而匹配出一个Unicode转义序列，也要注意<code>“\u”</code>前面只能有偶数个后向转义斜线。如<code>“\\u5409”</code>是不需要转换成“吉”这个字符的。</li>
  <li>不过，因为使用了非常危险的eval方法，所以必须要进行一些安全性检查，防止恶意代码被执行。</li>
</ol>

<p>最终的实现代码出人意料的简单：</p>

<div class="highlight"><pre><span></span><span class="sd">/**</span>
<span class="sd"> * JSON Decode</span>
<span class="sd"> * @param {String} $s The string json data.</span>
<span class="sd"> * @param {Boolean} [$assoc=false] Return assoc array if $assoc is true.</span>
<span class="sd"> * @return decode result corresponding object.</span>
<span class="sd"> */</span>
<span class="k">function</span> <span class="nf">json_parse</span><span class="p">(</span><span class="nv">$s</span><span class="p">,</span><span class="nv">$assoc</span><span class="o">=</span><span class="k">false</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">static</span> <span class="nv">$strings</span><span class="p">,</span><span class="nv">$count</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">is_string</span><span class="p">(</span><span class="nv">$s</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$s</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="nv">$s</span><span class="p">);</span>
    <span class="nv">$strings</span><span class="o">=</span><span class="k">array</span><span class="p">();</span>
    <span class="c1">//匹配字符串结束引号应该确保前面只能有偶数个&#39;\&#39;</span>
    <span class="c1">//如 &quot;ab\&quot;c&quot;中 \&quot; 不能被视为字符串结束引号</span>
    <span class="nv">$s</span><span class="o">=</span><span class="nb">preg_replace_callback</span><span class="p">(</span><span class="s1">&#39;/&quot;([\s\S]*?(?&lt;!\\\\)(?:\\\\\\\\)*)&quot;/&#39;</span><span class="p">,</span>
                              <span class="no">__FUNCTION__</span><span class="p">,</span><span class="nv">$s</span><span class="p">);</span>
    <span class="c1">//去除特殊字符后只需作简单的安全检测即可</span>
    <span class="nv">$clean</span><span class="o">=</span><span class="nb">str_replace</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;true&#39;</span><span class="p">,</span><span class="s1">&#39;false&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;null&#39;</span><span class="p">,</span><span class="s1">&#39;{&#39;</span><span class="p">,</span><span class="s1">&#39;}&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;[&#39;</span><span class="p">,</span><span class="s1">&#39;]&#39;</span><span class="p">,</span><span class="s1">&#39;,&#39;</span><span class="p">,</span><span class="s1">&#39;:&#39;</span><span class="p">,</span><span class="s1">&#39;#&#39;</span><span class="p">,</span><span class="s1">&#39;.&#39;</span><span class="p">),</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="nv">$s</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$clean</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">is_numeric</span><span class="p">(</span><span class="nv">$clean</span><span class="p">))</span> <span class="p">{</span><span class="c1">//可能是格式不正确的JSON或恶意代码</span>
      <span class="k">return</span> <span class="k">NULL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nv">$s</span><span class="o">=</span><span class="nb">str_replace</span><span class="p">(</span>
         <span class="k">array</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">,</span><span class="s1">&#39;[&#39;</span><span class="p">,</span><span class="s1">&#39;]&#39;</span><span class="p">,</span><span class="s1">&#39;}&#39;</span><span class="p">,</span><span class="s1">&#39;:&#39;</span><span class="p">,</span><span class="s1">&#39;null&#39;</span><span class="p">),</span>
         <span class="c1">//通过&#39;(object)&#39;类型转换将关联数组转换成stdClass instance</span>
         <span class="k">array</span><span class="p">((</span><span class="nv">$assoc</span><span class="o">?</span><span class="s1">&#39;&#39;</span><span class="o">:</span><span class="s1">&#39;(object)&#39;</span><span class="p">)</span><span class="o">.</span><span class="s1">&#39;array(&#39;</span><span class="p">,</span>
               <span class="s1">&#39;array(&#39;</span><span class="p">,</span><span class="s1">&#39;)&#39;</span><span class="p">,</span><span class="s1">&#39;)&#39;</span><span class="p">,</span><span class="s1">&#39;=&gt;&#39;</span><span class="p">,</span><span class="s1">&#39;NULL&#39;</span><span class="p">)</span>
         <span class="p">,</span><span class="nv">$s</span><span class="p">);</span>
    <span class="nv">$s</span><span class="o">=</span><span class="nb">preg_replace_callback</span><span class="p">(</span><span class="s1">&#39;/#\d+#/&#39;</span><span class="p">,</span><span class="no">__FUNCTION__</span><span class="p">,</span><span class="nv">$s</span><span class="p">);</span>
    <span class="c1">//抑制错误,如{3##}能通过上面的安全检测但却无法转换成正确的PHP代码</span>
    <span class="o">@</span><span class="nv">$data</span><span class="o">=</span><span class="k">eval</span><span class="p">(</span><span class="s2">&quot;return </span><span class="si">$s</span><span class="s2">;&quot;</span><span class="p">);</span>
    <span class="nv">$strings</span><span class="o">=</span><span class="nv">$count</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="c1">//GC</span>
    <span class="k">return</span> <span class="nv">$data</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$s</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span><span class="c1">//存储字符串</span>
    <span class="nv">$strings</span><span class="p">[]</span><span class="o">=</span><span class="nx">_unicode_unescape</span><span class="p">(</span>
                 <span class="nb">str_replace</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;$&#39;</span><span class="p">,</span><span class="s1">&#39;\\/&#39;</span><span class="p">),</span><span class="k">array</span><span class="p">(</span><span class="s1">&#39;\\$&#39;</span><span class="p">,</span><span class="s1">&#39;/&#39;</span><span class="p">),</span><span class="nv">$s</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
    <span class="k">return</span> <span class="s1">&#39;#&#39;</span><span class="o">.</span><span class="p">(</span><span class="nv">$count</span><span class="o">++</span><span class="p">)</span><span class="o">.</span><span class="s1">&#39;#&#39;</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span><span class="c1">//读取存储的值</span>
    <span class="nv">$index</span><span class="o">=</span><span class="nb">substr</span><span class="p">(</span><span class="nv">$s</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">1</span><span class="p">,</span><span class="nb">strlen</span><span class="p">(</span><span class="nv">$s</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">2</span><span class="p">);</span>
    <span class="k">return</span> <span class="nv">$strings</span><span class="p">[</span><span class="nv">$index</span><span class="p">];</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">_unicode_unescape</span><span class="p">(</span><span class="nv">$data</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">is_string</span><span class="p">(</span><span class="nv">$data</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">//匹配 Unicode escape时，需要注意匹配&#39;\u&#39;前面只能有偶数个&#39;\&#39;</span>
    <span class="c1">//    &#39;\\u5409&#39;不应被匹配</span>
    <span class="k">return</span> <span class="nb">preg_replace_callback</span><span class="p">(</span>
           <span class="s1">&#39;/(?&lt;!\\\\)((?:\\\\\\\\)*)\\\\u([a-f0-9]{2})([a-f0-9]{2})/i&#39;</span><span class="p">,</span>
           <span class="no">__FUNCTION__</span><span class="p">,</span><span class="nv">$data</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nv">$data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="nb">iconv</span><span class="p">(</span><span class="s2">&quot;UCS-2BE&quot;</span><span class="p">,</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">,</span>
                        <span class="nb">chr</span><span class="p">(</span><span class="nb">hexdec</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span><span class="o">.</span><span class="nb">chr</span><span class="p">(</span><span class="nb">hexdec</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="mi">3</span><span class="p">])));</span>
<span class="p">}</span>
</pre></div>

<h3>性能</h3>
<p>
  和PHP 5.2之后C语言实现的JSON方法相比，这里的实现自然要慢很多，根本不是一个数量级上的。
  <a href="http://pear.php.net/" target="_blank">PEAR</a>上有一个纯PHP实现的JSON库：<a href="http://pear.php.net/package/Services_JSON" target="_blank">Services_JSON</a>。作为比较，我做了一个简单的性能对比测试，结果发现Services_JSON的encode方法比<code>json_stringify</code>方法慢三四倍，而其decode方法更是比<code>json_parse</code>方法慢几十倍。
  对于<code>json_stringify</code>方法，应该是主要得益于使用<a href="http://www.php.net/manual/en/function.iconv.php" target="_blank">iconv</a>先将UTF-8字符串转换成UCS-2BE，再转换到Unicode转义序列，自然要比纯PHP实现UTF-8到Unicode转义序列的性能更高。对于<code>json_parse</code>方法，虽然一般的递归下降Parser只需扫描一次，这里的实现要扫描多次，但由于都是使用Native函数，再加上<a href="http://php.net/manual/en/function.eval.php" target="_blank">eval</a>这个非常规手段，最终性能上反而胜出也就可以理解了。
</p>
    
  </article>
  <hr />
  
    <nav class="near-posts link-list">
    
            <a href="./memoization-in-php.html" rel="next"><i>⇦</i><em>Memoization in PHP</em></a>
        
        
    </nav>
    <hr />
  

  
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = "jexim";
        var disqus_config = function () {
          this.page.url = "https://jex.im/./json-eval-trick-in-php.html";
          this.page.identifier = "programming/json-eval-trick-in-php";
          this.page.category_id = "programming";
          this.page.title = "JSON Eval Trick in PHP";
        };

        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  


<!-- Build: 2019-07-14 13:22:43 +0800 -->
  <footer class="site-footer">
      <a rel="license"
      title="This blog is licensed under a Creative Commons Attribution-ShareAlike 3.0 Unported License."
      href="https://creativecommons.org/licenses/by-sa/3.0/deed.zh" target="_blank"><!--img alt="知识共享许可协议" src="https://i.creativecommons.org/l/by-sa/3.0/80x15.png" width="80" height="14" /--><img width="80" height="15" title="知识共享许可协议" alt="知识共享许可协议" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPCAIAAAD8q9/YAAAABGdBTUEAANbY1E9YMgAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAIySURBVHjaYmAYYYARiP///z9SfMvIyAJhrdm0Glliz669M6fO7OjoKC8vx9Tm6up66tSptu5WcQlxIFdeVsHVyfXjh4+D3LeQeGXClHj54uXyxctx+RYIdu/ebWZmNrl/CoT74eOHwoLCoRLJWDy8fMkKYWFhXL6FAGBw3Lxxc8PajUD2x08fPHw8vH28h6qHL128lJ6eDmScPXtWWVkZmO6Bafj9+/dAEsgGigDFjY2NXVxcrl29BjWFiQnIRUs/EICcnDDZ+LXQonBhwvDt5c+fPgP9A2SHhYUBGUBbgWRnZyfQn+/evQPG/L1794CyQME7t+/AUzUwkWOWEEAAcTScASSBbKy+ZYQBZC7V/Yzu4a9fvgBJQUFBYJQCPQbxOTABA9lKSkpA8bS0tNDQUFgRD3X6z58/GFkYscYY3HsQ18O5aPEJkUVLCPSIYW4eHiAJ9C3Qb0AfAmMVUiwDuUA/A8UrKipmzZqFljjZ2Tn+//mPJ4ax1hDw+MSqHk2WVh7W09fl5eWF+BMYsXv27AHaCvQ5kA2MbSEhIaAIJLueOXNGUVkRokuAXwBYUeGPYYJ1BknqKW14INfDfV39z58+v3//Ph5twBAxMTGJjosOCPYHcmWl5Zobmrdu2TrI62FgaGIppaPjot6+fQOMUjyay8rKVFSVIb7l5xPYsWXHIPctvmoJ2H5KzUytrKxsb2/HqsfJ2en69esFJQXw9Nw/oX+0LT1I29IjrbPEABBgAEdwNeO7yfOaAAAAAElFTkSuQmCC" /></a>
      <small>
        Powered by <a href="https://jex.im/PlainSite/" target="_blank">PlainSite</a>.
      </small>
  </footer>
</body>
</html>